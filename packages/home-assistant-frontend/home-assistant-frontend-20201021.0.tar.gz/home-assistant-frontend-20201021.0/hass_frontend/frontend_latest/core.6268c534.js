(()=>{var e,t={50936:(e,t,s)=>{"use strict";s.d(t,{gx:()=>i,v0:()=>c});var n=s(92130);function o(e,t,s,n){s+=(s.includes("?")?"&":"?")+"auth_callback=1",document.location.href=function(e,t,s,n){let o=`${e}/auth/authorize?response_type=code&redirect_uri=${encodeURIComponent(s)}`;return null!==t&&(o+="&client_id="+encodeURIComponent(t)),n&&(o+="&state="+encodeURIComponent(n)),o}(e,t,s,n)}async function r(e,t,s){const o="undefined"!=typeof location&&location;if(o&&"https:"===o.protocol){const t=document.createElement("a");if(t.href=e,"http:"===t.protocol&&"localhost"!==t.hostname)throw n.rh}const r=new FormData;null!==t&&r.append("client_id",t),Object.keys(s).forEach(e=>{r.append(e,s[e])});const a=await fetch(e+"/auth/token",{method:"POST",credentials:"same-origin",body:r});if(!a.ok)throw 400===a.status||403===a.status?n.DJ:new Error("Unable to fetch tokens");const i=await a.json();return i.hassUrl=e,i.clientId=t,i.expires=1e3*i.expires_in+Date.now(),i}function a(e,t,s){return r(e,t,{code:s,grant_type:"authorization_code"})}class i{constructor(e,t){this.data=e,this._saveTokens=t}get wsUrl(){return`ws${this.data.hassUrl.substr(4)}/api/websocket`}get accessToken(){return this.data.access_token}get expired(){return Date.now()>this.data.expires}async refreshAccessToken(){if(!this.data.refresh_token)throw new Error("No refresh_token");const e=await r(this.data.hassUrl,this.data.clientId,{grant_type:"refresh_token",refresh_token:this.data.refresh_token});e.refresh_token=this.data.refresh_token,this.data=e,this._saveTokens&&this._saveTokens(e)}async revoke(){if(!this.data.refresh_token)throw new Error("No refresh_token to revoke");const e=new FormData;e.append("action","revoke"),e.append("token",this.data.refresh_token),await fetch(this.data.hassUrl+"/auth/token",{method:"POST",credentials:"same-origin",body:e}),this._saveTokens&&this._saveTokens(null)}}async function c(e={}){let t,s=e.hassUrl;s&&"/"===s[s.length-1]&&(s=s.substr(0,s.length-1));const r=void 0!==e.clientId?e.clientId:`${location.protocol}//${location.host}/`;if(!t&&e.authCode&&s&&(t=await a(s,r,e.authCode),e.saveTokens&&e.saveTokens(t)),!t){const s=function(e){const t={},s=e.split("&");for(let n=0;n<s.length;n++){const e=s[n].split("="),o=decodeURIComponent(e[0]),r=e.length>1?decodeURIComponent(e[1]):void 0;t[o]=r}return t}(location.search.substr(1));if("auth_callback"in s){const n=(c=s.state,JSON.parse(atob(c)));t=await a(n.hassUrl,n.clientId,s.code),e.saveTokens&&e.saveTokens(t)}}var c,d;if(!t&&e.loadTokens&&(t=await e.loadTokens()),t)return new i(t,e.saveTokens);if(void 0===s)throw n.Js;return o(s,r,e.redirectUrl||function(){const{protocol:e,host:t,pathname:s,search:n}=location;return`${e}//${t}${s}${n}`}(),(d={hassUrl:s,clientId:r},btoa(JSON.stringify(d)))),new Promise(()=>{})}},92130:(e,t,s)=>{"use strict";s.d(t,{OH:()=>n,DJ:()=>o,Wf:()=>r,Js:()=>a,rh:()=>i});const n=1,o=2,r=3,a=4,i=5},28210:()=>{},37846:()=>{if(/^((?!chrome|android).)*version\/14\.0.*safari/i.test(navigator.userAgent)){const e=window.Element.prototype.attachShadow;window.Element.prototype.attachShadow=function(t){return t&&t.delegatesFocus&&delete t.delegatesFocus,e.apply(this,[t])}}}},s={};function n(e){if(s[e])return s[e].exports;var o=s[e]={exports:{}};return t[e](o,o.exports,n),o.exports}n.m=t,n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((t,s)=>(n.f[s](e,t),t),[])),n.u=e=>"chunk.aec03ddbec849ba384bf.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},n.l=(t,s,o)=>{if(e[t])e[t].push(s);else{var r,a;if(void 0!==o)for(var i=document.getElementsByTagName("script"),c=0;c<i.length;c++){var d=i[c];if(d.getAttribute("src")==t||d.getAttribute("data-webpack")=="home-assistant-frontend:"+o){r=d;break}}r||(a=!0,(r=document.createElement("script")).charset="utf-8",r.timeout=120,n.nc&&r.setAttribute("nonce",n.nc),r.setAttribute("data-webpack","home-assistant-frontend:"+o),r.src=t),e[t]=[s];var u=(s,n)=>{r.onerror=r.onload=null,clearTimeout(h);var o=e[t];if(delete e[t],r.parentNode&&r.parentNode.removeChild(r),o&&o.forEach(e=>e(n)),s)return s(n)},h=setTimeout(u.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=u.bind(null,r.onerror),r.onload=u.bind(null,r.onload),a&&document.head.appendChild(r)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="/frontend_latest/",(()=>{var e={1321:0};n.f.j=(t,s)=>{var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)s.push(o[2]);else{var r=new Promise((s,n)=>{o=e[t]=[s,n]});s.push(o[2]=r);var a=n.p+n.u(t),i=new Error;n.l(a,s=>{if(n.o(e,t)&&(0!==(o=e[t])&&(e[t]=void 0),o)){var r=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;i.message="Loading chunk "+t+" failed.\n("+r+": "+a+")",i.name="ChunkLoadError",i.type=r,i.request=a,o[1](i)}},"chunk-"+t)}};var t=self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[],s=t.push.bind(t);t.push=t=>{for(var o,r,[a,i,c]=t,d=0,u=[];d<a.length;d++)r=a[d],n.o(e,r)&&e[r]&&u.push(e[r][0]),e[r]=0;for(o in i)n.o(i,o)&&(n.m[o]=i[o]);for(c&&c(n),s(t);u.length;)u.shift()()}})(),(()=>{"use strict";var e=n(92130);n(28210),n(37846);function t(e){return{type:"unsubscribe_events",subscription:e}}function s(t){if(!t.auth)throw e.Js;const s=t.auth;let n=s.expired?s.refreshAccessToken().then(()=>{n=void 0},()=>{n=void 0}):void 0;const o=s.wsUrl;return new Promise((r,a)=>function t(r,a,i){const c=new WebSocket(o);let d=!1;const u=()=>{if(c.removeEventListener("close",u),d)return void i(e.DJ);if(0===r)return void i(e.OH);const s=-1===r?-1:r-1;setTimeout(()=>t(s,a,i),1e3)},h=async t=>{try{s.expired&&await(n||s.refreshAccessToken()),c.send(JSON.stringify({type:"auth",access_token:s.accessToken}))}catch(o){d=o===e.DJ,c.close()}},l=async e=>{const t=JSON.parse(e.data);switch(t.type){case"auth_invalid":d=!0,c.close();break;case"auth_ok":c.removeEventListener("open",h),c.removeEventListener("message",l),c.removeEventListener("close",u),c.removeEventListener("error",u),c.haVersion=t.ha_version,a(c);break;default:0}};c.addEventListener("open",h),c.addEventListener("message",l),c.addEventListener("close",u),c.addEventListener("error",u)}(t.setupRetry,r,a))}class o{constructor(e,t){this.options=t,this.commandId=1,this.commands=new Map,this.eventListeners=new Map,this.closeRequested=!1,this.setSocket(e)}get haVersion(){return this.socket.haVersion}get connected(){return this.socket.readyState==this.socket.OPEN}setSocket(e){const t=this.socket;if(this.socket=e,e.addEventListener("message",e=>this._handleMessage(e)),e.addEventListener("close",e=>this._handleClose(e)),t){const e=this.commands;this.commandId=1,this.commands=new Map,e.forEach(e=>{"subscribe"in e&&e.subscribe().then(t=>{e.unsubscribe=t,e.resolve()})});const t=this._queuedMessages;if(t){this._queuedMessages=void 0;for(const e of t)e.resolve()}this.fireEvent("ready")}}addEventListener(e,t){let s=this.eventListeners.get(e);s||(s=[],this.eventListeners.set(e,s)),s.push(t)}removeEventListener(e,t){const s=this.eventListeners.get(e);if(!s)return;const n=s.indexOf(t);-1!==n&&s.splice(n,1)}fireEvent(e,t){(this.eventListeners.get(e)||[]).forEach(e=>e(this,t))}suspendReconnectUntil(e){this.suspendReconnectPromise=e}suspend(){if(!this.suspendReconnectPromise)throw new Error("Suspend promise not set");this.socket.close()}close(){this.closeRequested=!0,this.socket.close()}async subscribeEvents(e,t){return this.subscribeMessage(e,function(e){const t={type:"subscribe_events"};return e&&(t.event_type=e),t}(t))}ping(){return this.sendMessagePromise({type:"ping"})}sendMessage(e,t){if(this._queuedMessages){if(t)throw new Error("Cannot queue with commandId");this._queuedMessages.push({resolve:()=>this.sendMessage(e)})}else t||(t=this._genCmdId()),e.id=t,this.socket.send(JSON.stringify(e))}sendMessagePromise(e){return new Promise((t,s)=>{if(this._queuedMessages)return void this._queuedMessages.push({reject:s,resolve:async()=>{try{t(await this.sendMessagePromise(e))}catch(n){s(n)}}});const n=this._genCmdId();this.commands.set(n,{resolve:t,reject:s}),this.sendMessage(e,n)})}async subscribeMessage(e,s){let n;return this._queuedMessages&&await new Promise((e,t)=>{this._queuedMessages.push({resolve:e,reject:t})}),await new Promise((o,r)=>{const a=this._genCmdId();n={resolve:o,reject:r,callback:e,subscribe:()=>this.subscribeMessage(e,s),unsubscribe:async()=>{this.connected&&await this.sendMessagePromise(t(a)),this.commands.delete(a)}},this.commands.set(a,n);try{this.sendMessage(s,a)}catch(i){}}),()=>n.unsubscribe()}_handleMessage(e){const s=JSON.parse(e.data);const n=this.commands.get(s.id);switch(s.type){case"event":n?n.callback(s.event):(console.warn(`Received event for unknown subscription ${s.id}. Unsubscribing.`),this.sendMessagePromise(t(s.id)));break;case"result":n&&(s.success?(n.resolve(s.result),"subscribe"in n||this.commands.delete(s.id)):(n.reject(s.error),this.commands.delete(s.id)));break;case"pong":n?(n.resolve(),this.commands.delete(s.id)):console.warn("Received unknown pong response "+s.id);break;default:0}}async _handleClose(t){if(this.commands.forEach(t=>{"subscribe"in t||t.reject({type:"result",success:!1,error:{code:e.Wf,message:"Connection lost"}})}),this.closeRequested)return;this.fireEvent("disconnected");const s=Object.assign(Object.assign({},this.options),{setupRetry:0}),n=t=>{setTimeout(async()=>{try{const e=await s.createSocket(s);this.setSocket(e)}catch(o){if(this._queuedMessages){const t=this._queuedMessages;this._queuedMessages=void 0;for(const s of t)s.reject&&s.reject(e.Wf)}o===e.DJ?this.fireEvent("reconnect-error",o):n(t+1)}},1e3*Math.min(t,5))};this.suspendReconnectPromise&&(await this.suspendReconnectPromise,this.suspendReconnectPromise=void 0,this._queuedMessages=[]),n(0)}_genCmdId(){return++this.commandId}}async function r(e){const t=Object.assign({setupRetry:0,createSocket:s},e),n=await t.createSocket(t);return new o(n,t)}const a=e=>{let t=[];function s(s,n){e=n?s:Object.assign(Object.assign({},e),s);let o=t;for(let t=0;t<o.length;t++)o[t](e)}return{get state(){return e},action(t){function n(e){s(e,!1)}return function(){let s=[e];for(let e=0;e<arguments.length;e++)s.push(arguments[e]);let o=t.apply(this,s);if(null!=o)return o instanceof Promise?o.then(n):n(o)}},setState:s,subscribe:e=>(t.push(e),()=>{!function(e){let s=[];for(let n=0;n<t.length;n++)t[n]===e?e=null:s.push(t[n]);t=s}(e)})}},i=(e,t,s,n)=>{if(e[t])return e[t];let o,r=0,i=a();const c=()=>s(e).then(e=>i.setState(e,!0)),d=()=>c().catch(t=>{if(e.connected)throw t});return e[t]={get state(){return i.state},refresh:c,subscribe(t){r++,1===r&&(n&&(o=n(e,i)),e.addEventListener("ready",d),d());const s=i.subscribe(t);return void 0!==i.state&&setTimeout(()=>t(i.state),0),()=>{s(),r--,r||(o&&o.then(e=>{e()}),e.removeEventListener("ready",c))}}},e[t]},c=(e,t,s,n,o)=>i(n,e,t,s).subscribe(o),d=e=>e.sendMessagePromise({type:"get_states"});async function u(e){const t=await d(e),s={};for(let n=0;n<t.length;n++){const e=t[n];s[e.entity_id]=e}return s}const h=(e,t)=>e.subscribeEvents(e=>function(e,t){const s=e.state;if(void 0===s)return;const{entity_id:n,new_state:o}=t.data;if(o)e.setState({[o.entity_id]:o});else{const t=Object.assign({},s);delete t[n],e.setState(t,!0)}}(t,e),"state_changed"),l=(e,t)=>(e=>i(e,"_ent",u,h))(e).subscribe(t);function f(e,t){return void 0===e?null:{components:e.components.concat(t.data.component)}}const p=e=>e.sendMessagePromise({type:"get_config"}),m=(e,t)=>Promise.all([e.subscribeEvents(t.action(f),"component_loaded"),e.subscribeEvents(()=>p(e).then(e=>t.setState(e,!0)),"core_config_updated")]).then(e=>()=>e.forEach(e=>e())),v=(e,t)=>(e=>i(e,"_cnf",p,m))(e).subscribe(t);function g(e,t){if(void 0===e)return null;const{domain:s,service:n}=t.data;return{[s]:Object.assign({},e[s],{[n]:{description:"",fields:{}}})}}function b(e,t){if(void 0===e)return null;const{domain:s,service:n}=t.data,o=e[s];if(!o||!(n in o))return null;const r={};return Object.keys(o).forEach(e=>{e!==n&&(r[e]=o[e])}),{[s]:r}}const w=e=>e.sendMessagePromise({type:"get_services"}),k=(e,t)=>Promise.all([e.subscribeEvents(t.action(g),"service_registered"),e.subscribeEvents(t.action(b),"service_removed")]).then(e=>()=>e.forEach(e=>e())),_=(e,t)=>(e=>i(e,"_srv",w,k))(e).subscribe(t);var y=n(50936);const E=window.localStorage||{};let P=window.__tokenCache;function M(e){if(P.tokens=e,P.writeEnabled)try{E.hassTokens=JSON.stringify(e)}catch(t){}}P||(P=window.__tokenCache={tokens:void 0,writeEnabled:void 0});const S=`${location.protocol}//${location.host}`;var T,O;const C=window.externalApp||(null===(T=window.webkit)||void 0===T||null===(O=T.messageHandlers)||void 0===O?void 0:O.getExternalAuth)||location.search.includes("external_auth=1"),j=(e,t)=>((e,t,s,n,o)=>{const r=s+"-optimistic";return{...i(t,s,n,async(e,s)=>{const n=o?o(t,s):void 0;return t[r]=s,()=>{n&&n.then(e=>e()),t[r]=void 0}}),async save(s){const n=t[r];let o;n&&(o=n.state,n.setState(s,!0));try{return await e(t,s)}catch(a){throw n&&n.setState(o,!0),a}}}})((s,n)=>(async(e,t,s)=>e.sendMessagePromise({type:"frontend/set_user_data",key:t,value:s}))(e,t,n),e,"_frontendUserData-"+t,()=>(async(e,t)=>(await e.sendMessagePromise({type:"frontend/get_user_data",key:t})).value)(e,t)),L=(e,t,s)=>e.sendMessagePromise({type:"lovelace/config",url_path:t,force:s}),R=e=>e.sendMessagePromise({type:"get_panels"}),I=(e,t)=>e.subscribeEvents(()=>R(e).then(e=>t.setState(e,!0)),"panels_updated"),U=e=>e.sendMessagePromise({type:"frontend/get_themes"}),q=(e,t)=>e.subscribeEvents(()=>U(e).then(e=>t.setState(e,!0)),"themes_updated"),x=(e,t)=>(e=>i(e,"_usr",()=>e.sendMessagePromise({type:"auth/current_user"}),void 0))(e).subscribe(t),J=C?()=>n.e(3074).then(n.bind(n,43047)).then(({createExternalAuth:e})=>e(S)):()=>(0,y.v0)({hassUrl:S,saveTokens:M,loadTokens:()=>Promise.resolve(function(){if(void 0===P.tokens)try{delete E.tokens;const e=E.hassTokens;e?(P.tokens=JSON.parse(e),P.writeEnabled=!0):P.tokens=null}catch(e){P.tokens=null}return P.tokens}())});window.hassConnection=J().then(async t=>{try{const e=await r({auth:t});return location.search.includes("auth_callback=1")&&history.replaceState(null,"",location.pathname),{auth:t,conn:e}}catch(s){if(s!==e.DJ)throw s;C?await t.refreshAccessToken(!0):M(null);return{auth:t=await J(),conn:await r({auth:t})}}}),window.hassConnectionReady&&window.hassConnectionReady(window.hassConnection),window.hassConnection.then(({conn:e})=>{const t=()=>{};if(l(e,t),v(e,t),_(e,t),((e,t)=>{c("_pnl",R,I,e,t)})(e,t),((e,t)=>{c("_thm",U,q,e,t)})(e,t),x(e,t),((e,t,s)=>{j(e,t).subscribe(s)})(e,"core",t),"/"===location.pathname||location.pathname.startsWith("/lovelace/")){const t=window;t.llConfProm=L(e,null,!1),t.llConfProm.catch(()=>{}),t.llResProm=(e=>e.sendMessagePromise({type:"lovelace/resources"}))(e)}}),window.addEventListener("error",e=>{if("ResizeObserver loop limit exceeded"===e.message)return e.stopImmediatePropagation(),void e.stopPropagation();const t=document.querySelector("home-assistant");t&&t.hass&&t.hass.callService&&t.hass.callService("system_log","write",{logger:"frontend.js.latest."+"20201021.0".replace(".",""),message:`${e.filename}:${e.lineno}:${e.colno} ${e.message}`})})})()})();
//# sourceMappingURL=core.6268c534.js.map