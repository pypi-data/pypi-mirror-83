import*as c from"../web_modules/react.js";import*as f from"../web_modules/react-dom.js";import b from"../web_modules/htm.js";import*as l from"../web_modules/fast-json-patch.js";import g from"./event-to-object.js";const u=b.bind(c.createElement),w={};export function mountLayoutWithWebSocket(n,t){if(t.startsWith(".")||t.startsWith("/")){let o=window.location,a;o.protocol==="https:"?a="wss:":a="ws:";let i=a+"//"+o.host;t.startsWith(".")&&(new_url+=o.pathname+"/"),t=i+t}const e=new WebSocket(t);function s(o){e.onmessage=a=>{const[i,$]=JSON.parse(a.data);o(i,$)}}function r(o){e.send(JSON.stringify({header:{},body:{event:o}}))}return mountLayout(n,s,r)}export function mountLayout(n,t,e){f.render(u`<${p} saveUpdateHook=${t} sendEvent=${e} />`,n)}export default function p({saveUpdateHook:n,sendEvent:t}){const[e,s]=P({});return c.useEffect(()=>{n((r,o)=>{s(l.applyPatch(e.current,o.map(a=>(a.path=r+a.path,a)),void 0,!1).newDocument)})},[e]),e.current.tagName?u`<${m}
      sendEvent=${t}
      model=${e.current}
    />`:u`<div />`}function m({sendEvent:n,model:t}){if(t.importSource)return u`<${y} sendEvent=${n} model=${t} />`;{const e=h(n,t),s=d(n,t);return t.children&&t.children.length?u`<${t.tagName} ...${s}>${e}<//>`:u`<${t.tagName} ...${s} />`}}function y({sendEvent:n,model:t}){const e=v(t.importSource.source);if(e){const s=S(e,t.tagName),r=h(n,t),o=d(n,t);return u`<${s} ...${o}>${r}<//>`}else return u`<div>${t.importSource.fallback}<//>`}function h(n,t){return t.children?t.children.map(e=>{switch(typeof e){case"object":return u`<${m} model=${e} sendEvent=${n} />`;case"string":return e}}):[]}function d(n,t){const e=Object.assign({},t.attributes);return t.eventHandlers&&Object.keys(t.eventHandlers).forEach(s=>{const r=t.eventHandlers[s];e[s]=j(n,r)}),e}function j(n,t){return function(){const e=Array.from(arguments).map(r=>typeof r=="object"&&r.nativeEvent?(t.preventDefault&&r.preventDefault(),t.stopPropagation&&r.stopPropagation(),g(r)):r),s=new Promise((r,o)=>{const a={data:e,target:t.target};n(a),r(a)})}}function v(n){const[t,e]=c.useState(w[n]);return t||E(n).then(e),t}function E(n){return import(n).then(t=>t.default?t.default:t,t=>{if(t.stack)return console.log(t),{default:function(){return u`
              <pre>
                  <h1>Error</h1>
                  <code>${[t.stack,t.message]}</code>
                </pre
              >
            `}};throw t})}function S(n,t){const e=t.split("."),s=e.shift();let r=n[s];for(let o=0;o<e.length;o++)r=r[e[o]];return r}function P(n){const t=c.useRef(n),[e,s]=c.useState(n);return t.current=e,[t,s]}
